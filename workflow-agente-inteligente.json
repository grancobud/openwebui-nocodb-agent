{
  "name": "ğŸ¤– Agente OpenWebUI â†” NocoDB",
  "tags": ["agente", "openwebui", "nocodb", "automatizacion"],
  "settings": {
    "executionOrder": "v1"
  },
  "nodes": [
    {
      "parameters": {
        "path": "openwebui-chat",
        "responseMode": "responseNode",
        "options": {}
      },
      "name": "ğŸ“¡ Webhook OpenWebUI",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [200, 300],
      "webhookId": "openwebui-chat-webhook"
    },
    {
      "parameters": {
        "jsCode": "// ğŸ¤– PROCESADOR INTELIGENTE DE MENSAJES\nconst userMessage = $input.first().json.user_message || $input.first().json.message || '';\nconst sessionId = $input.first().json.session_id || 'session_' + Date.now();\nconst userId = $input.first().json.user_id || 'user_unknown';\n\n// ğŸ“ PALABRAS CLAVE PARA DETECTAR ACCIÃ“N\nconst writeKeywords = ['agregar', 'aÃ±adir', 'crear', 'registrar', 'guardar', 'anotar', 'ingresar', 'nueva', 'nuevo'];\nconst readKeywords = ['mostrar', 'ver', 'listar', 'buscar', 'consultar', 'Â¿quÃ©', 'Â¿cuÃ¡nto', 'Â¿cuÃ¡l', 'estado', 'inventario'];\n\nconst lowerMessage = userMessage.toLowerCase();\n\n// ğŸ¯ DETECTAR INTENCIÃ“N\nconst isWrite = writeKeywords.some(keyword => lowerMessage.includes(keyword));\nconst isRead = readKeywords.some(keyword => lowerMessage.includes(keyword)) || lowerMessage.includes('?');\n\n// âœ… DECISIÃ“N FINAL\nlet action = 'read'; // Por defecto leer\nif (isWrite && !isRead) {\n  action = 'write';\n} else if (isWrite && isRead) {\n  // Si tiene ambos, priorizamos segÃºn estructura\n  action = lowerMessage.match(/^(agregar|aÃ±adir|crear|registrar|guardar)/) ? 'write' : 'read';\n}\n\nreturn {\n  json: {\n    action: action,\n    user_message: userMessage,\n    session_id: sessionId,\n    user_id: userId,\n    original_payload: $input.first().json,\n    decision_reason: `DetectÃ© ${writeKeywords.filter(k => lowerMessage.includes(k)).length} palabras de escritura y ${readKeywords.filter(k => lowerMessage.includes(k)).length} de lectura`\n  }\n};"
      },
      "name": "ğŸ§  Analizador de IntenciÃ³n",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [400, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.action }}",
              "operation": "equal",
              "value2": "write"
            }
          ]
        }
      },
      "name": "ğŸ¤” Â¿Escribir o Leer?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [600, 300]
    },
    {
      "parameters": {
        "jsCode": "// ğŸ“ EXTRACTOR INTELIGENTE DE DATOS\nconst userMessage = $input.first().json.user_message.toLowerCase();\nconst sessionId = $input.first().json.session_id;\nconst userId = $input.first().json.user_id;\n\n// ğŸ¯ DATOS BASE\nlet extractedData = {\n  Usuario_Registro: \"ğŸ¤– Agente ChatBot\",\n  Responsable: \"Sistema Automatizado\",\n  Estado: \"Registrado por IA\",\n  Notas: `ğŸ“± Creado desde chat: \"${$input.first().json.user_message}\"`\n};\n\n// ğŸŒ¿ EXTRAER VARIEDAD\nconst variedadPatterns = [\n  /variedad\\s+([\\w\\s]+?)(?=,|\\s+\\d|\\s+categor|\\s+responsable|$)/i,\n  /([\\w\\s]+?)\\s+variedad/i,\n  /strain\\s+([\\w\\s]+?)(?=,|\\s+\\d|$)/i\n];\n\nfor (let pattern of variedadPatterns) {\n  const match = userMessage.match(pattern);\n  if (match) {\n    extractedData.Variedad = match[1].trim();\n    break;\n  }\n}\n\n// âš–ï¸ EXTRAER PESO\nconst pesoPatterns = [\n  /(\\d+(?:\\.\\d+)?)\\s*g(?:ramos?)?/i,\n  /(\\d+(?:\\.\\d+)?)\\s*kg/i // Convertir kg a g\n];\n\nfor (let pattern of pesoPatterns) {\n  const match = userMessage.match(pattern);\n  if (match) {\n    let peso = parseFloat(match[1]);\n    if (pattern.source.includes('kg')) {\n      peso = peso * 1000; // Convertir kg a gramos\n    }\n    extractedData.Peso_Neto_g = peso.toString();\n    break;\n  }\n}\n\n// ğŸ‘¤ EXTRAER RESPONSABLE\nconst responsablePatterns = [\n  /responsable\\s+([\\w\\s]+?)(?=,|$)/i,\n  /a\\s+cargo\\s+de\\s+([\\w\\s]+?)(?=,|$)/i,\n  /encargado\\s+([\\w\\s]+?)(?=,|$)/i\n];\n\nfor (let pattern of responsablePatterns) {\n  const match = userMessage.match(pattern);\n  if (match) {\n    extractedData.Responsable = match[1].trim();\n    break;\n  }\n}\n\n// ğŸ“‹ EXTRAER CATEGORÃA\nconst categoriaPatterns = [\n  /categor[Ã­i]a\\s+([AB])(?:\\s+[^,]*)?/i,\n  /clase\\s+([AB])/i,\n  /tipo\\s+([AB])/i\n];\n\nfor (let pattern of categoriaPatterns) {\n  const match = userMessage.match(pattern);\n  if (match) {\n    if (match[1].toUpperCase() === 'A') {\n      extractedData.Categoria_Producto = \"A Mayor a 2.5 cm\";\n    } else {\n      extractedData.Categoria_Producto = \"B Igual o menos a 2.5 cm\";\n    }\n    break;\n  }\n}\n\n// ğŸ¢ EXTRAER UBICACIÃ“N\nconst ubicacionPatterns = [\n  /ubicaci[Ã³o]n\\s+([\\w\\s]+?)(?=,|$)/i,\n  /almac[Ã©e]n\\s+([\\w\\s]+?)(?=,|$)/i,\n  /sala\\s+([\\w\\s]+?)(?=,|$)/i\n];\n\nfor (let pattern of ubicacionPatterns) {\n  const match = userMessage.match(pattern);\n  if (match) {\n    extractedData.Ubicacion_Almacenamiento = match[1].trim();\n    break;\n  }\n}\n\n// ğŸ”¢ GENERAR CÃ“DIGO DE TRAZABILIDAD ÃšNICO\nconst today = new Date();\nconst year = today.getFullYear().toString().slice(-2);\nconst month = String(today.getMonth() + 1).padStart(2, '0');\nconst day = String(today.getDate()).padStart(2, '0');\nconst hour = String(today.getHours()).padStart(2, '0');\nconst minute = String(today.getMinutes()).padStart(2, '0');\nconst randomId = Math.floor(Math.random() * 1000).toString().padStart(3, '0');\n\nconst variedadCode = extractedData.Variedad ? extractedData.Variedad.slice(0,3).toUpperCase() : 'AGT';\nextractedData.Codigo_Trazabilidad_Almacenamiento = `${year}.${month}${day}.${hour}${minute}-${variedadCode}-${randomId}`;\n\n// ğŸ“… FECHAS AUTOMÃTICAS\nextractedData.Fecha_Almacenamiento = today.toISOString().split('T')[0];\nextractedData.Fecha_Ultima_Revision = today.toISOString().split('T')[0];\n\n// ğŸª VALORES POR DEFECTO INTELIGENTES\nif (!extractedData.Tipo_Contenedor) {\n  extractedData.Tipo_Contenedor = \"Terp Block\";\n}\nif (!extractedData.Ubicacion_Almacenamiento) {\n  extractedData.Ubicacion_Almacenamiento = \"Sala Almacenamiento\";\n}\nif (!extractedData.Condiciones_Almacenamiento_Ideal) {\n  extractedData.Condiciones_Almacenamiento_Ideal = \"Pendiente RevisiÃ³n\";\n}\nif (!extractedData.Cuarentena) {\n  extractedData.Cuarentena = \"En Proceso\";\n}\nif (!extractedData.Camada) {\n  extractedData.Camada = \"C1\";\n}\nif (!extractedData.Lote_Almacenado) {\n  extractedData.Lote_Almacenado = \"L1\";\n}\n\n// âœ… RESULTADO FINAL\nreturn {\n  json: {\n    ...extractedData,\n    original_message: $input.first().json.user_message,\n    session_id: sessionId,\n    user_id: userId,\n    extracted_fields: Object.keys(extractedData).filter(key => extractedData[key] && !['Usuario_Registro', 'Estado'].includes(key))\n  }\n};"
      },
      "name": "ğŸ” Extractor de Datos",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [800, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:3091/api/v2/tables/mr9we3ldl7rcn3a/records",
        "authentication": "headerAuth",
        "headerAuth": {
          "name": "xc-token",
          "value": "REEMPLAZAR_CON_TU_TOKEN_NOCODB"
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {
          "response": {
            "fullResponse": false,
            "responseFormat": "json"
          }
        }
      },
      "name": "ğŸ’¾ Escribir en NocoDB",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1000, 200]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://localhost:3091/api/v2/tables/mr9we3ldl7rcn3a/records?limit=10&sort=-CreatedAt",
        "authentication": "headerAuth",
        "headerAuth": {
          "name": "xc-token",
          "value": "REEMPLAZAR_CON_TU_TOKEN_NOCODB"
        },
        "options": {
          "response": {
            "fullResponse": false,
            "responseFormat": "json"
          }
        }
      },
      "name": "ğŸ“– Leer de NocoDB",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [800, 400]
    },
    {
      "parameters": {
        "jsCode": "// ğŸ“Š FORMATEADOR DE RESPUESTA DE LECTURA\nconst response = $input.first().json;\nconst records = response.list || response.records || response;\n\nlet formattedResponse = \"ğŸ“‹ **Inventario Actual - Almacenamiento**\\n\\n\";\n\nif (!Array.isArray(records) || records.length === 0) {\n  formattedResponse = \"ğŸ“­ **No hay registros en el inventario actual**\\n\\n\";\n  formattedResponse += \"ğŸ’¡ *Puedes agregar productos diciendo: \\\"Agregar variedad Blue Dream, 35g, responsable Juan\\\"*\";\n} else {\n  records.slice(0, 10).forEach((record, index) => {\n    const data = record;\n    const num = index + 1;\n    \n    formattedResponse += `ğŸŒ¿ **${num}. ${data.Variedad || 'Sin variedad'}**\\n`;\n    \n    if (data.Categoria_Producto) {\n      formattedResponse += `   ğŸ“ CategorÃ­a: ${data.Categoria_Producto}\\n`;\n    }\n    if (data.Peso_Neto_g) {\n      formattedResponse += `   âš–ï¸ Peso: ${data.Peso_Neto_g}g\\n`;\n    }\n    if (data.Responsable) {\n      formattedResponse += `   ğŸ‘¤ Responsable: ${data.Responsable}\\n`;\n    }\n    if (data.Estado) {\n      const emoji = data.Estado.includes('Aprobado') ? 'âœ…' : 'â³';\n      formattedResponse += `   ${emoji} Estado: ${data.Estado}\\n`;\n    }\n    if (data.Lote_Almacenado) {\n      formattedResponse += `   ğŸ“¦ Lote: ${data.Lote_Almacenado}\\n`;\n    }\n    if (data.Fecha_Almacenamiento) {\n      formattedResponse += `   ğŸ“… Fecha: ${data.Fecha_Almacenamiento}\\n`;\n    }\n    if (data.Codigo_Trazabilidad_Almacenamiento) {\n      formattedResponse += `   ğŸ”¢ CÃ³digo: \\`${data.Codigo_Trazabilidad_Almacenamiento}\\`\\n`;\n    }\n    if (data.Ubicacion_Almacenamiento) {\n      formattedResponse += `   ğŸ¢ UbicaciÃ³n: ${data.Ubicacion_Almacenamiento}\\n`;\n    }\n    \n    formattedResponse += \"\\n\";\n  });\n  \n  formattedResponse += `\\nğŸ“Š **Resumen:**\\n`;\n  formattedResponse += `â€¢ Total registros mostrados: ${Math.min(records.length, 10)}\\n`;\n  \n  if (records.length > 10) {\n    formattedResponse += `â€¢ Hay ${records.length - 10} registros adicionales\\n`;\n  }\n  \n  // ğŸ§® ESTADÃSTICAS RÃPIDAS\n  const totalPeso = records.reduce((sum, r) => sum + (parseFloat(r.Peso_Neto_g) || 0), 0);\n  const variedades = [...new Set(records.map(r => r.Variedad).filter(v => v))];\n  const estados = [...new Set(records.map(r => r.Estado).filter(e => e))];\n  \n  formattedResponse += `â€¢ Peso total: ${totalPeso.toFixed(1)}g\\n`;\n  formattedResponse += `â€¢ Variedades: ${variedades.length} diferentes\\n`;\n  formattedResponse += `â€¢ Estados: ${estados.join(', ')}\\n`;\n}\n\nformattedResponse += \"\\nğŸ’¬ *Â¿Necesitas agregar algo nuevo o hacer otra consulta?*\";\n\nreturn {\n  json: {\n    response: formattedResponse,\n    action: \"read\",\n    total_records: Array.isArray(records) ? records.length : 0,\n    summary: {\n      total_weight: Array.isArray(records) ? records.reduce((s, r) => s + (parseFloat(r.Peso_Neto_g) || 0), 0) : 0,\n      varieties: Array.isArray(records) ? [...new Set(records.map(r => r.Variedad).filter(v => v))].length : 0\n    }\n  }\n};"
      },
      "name": "ğŸ“Š Formatear Respuesta Lectura",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1000, 400]
    },
    {
      "parameters": {
        "jsCode": "// âœ… FORMATEADOR DE RESPUESTA DE ESCRITURA\nconst createdRecord = $input.first().json;\nconst originalData = $('Extractor de Datos').first().json;\n\n// ğŸ‰ RESPUESTA DE Ã‰XITO\nlet response = `ğŸ‰ **Â¡Registro creado exitosamente!**\\n\\n`;\n\n// ğŸ“ DETALLES DEL REGISTRO\nresponse += `ğŸ“‹ **Detalles del nuevo registro:**\\n`;\n\nif (originalData.Variedad) {\n  response += `ğŸŒ¿ **Variedad:** ${originalData.Variedad}\\n`;\n}\nif (originalData.Peso_Neto_g) {\n  response += `âš–ï¸ **Peso:** ${originalData.Peso_Neto_g}g\\n`;\n}\nif (originalData.Responsable) {\n  response += `ğŸ‘¤ **Responsable:** ${originalData.Responsable}\\n`;\n}\nif (originalData.Categoria_Producto) {\n  response += `ğŸ“ **CategorÃ­a:** ${originalData.Categoria_Producto}\\n`;\n}\nif (originalData.Ubicacion_Almacenamiento) {\n  response += `ğŸ¢ **UbicaciÃ³n:** ${originalData.Ubicacion_Almacenamiento}\\n`;\n}\nif (originalData.Codigo_Trazabilidad_Almacenamiento) {\n  response += `ğŸ”¢ **CÃ³digo:** \\`${originalData.Codigo_Trazabilidad_Almacenamiento}\\`\\n`;\n}\n\nresponse += `ğŸ“… **Fecha:** ${originalData.Fecha_Almacenamiento || 'Hoy'}\\n`;\nresponse += `ğŸ“Š **Estado:** ${originalData.Estado}\\n`;\n\n// ğŸ†” ID DEL REGISTRO\nif (createdRecord.Id || createdRecord.id) {\n  response += `ğŸ†” **ID del registro:** #${createdRecord.Id || createdRecord.id}\\n`;\n}\n\nresponse += `\\n`;\n\n// ğŸ” CAMPOS DETECTADOS AUTOMÃTICAMENTE\nif (originalData.extracted_fields && originalData.extracted_fields.length > 0) {\n  response += `ğŸ¤– **Campos detectados automÃ¡ticamente:**\\n`;\n  originalData.extracted_fields.forEach(field => {\n    const emoji = {\n      'Variedad': 'ğŸŒ¿',\n      'Peso_Neto_g': 'âš–ï¸',\n      'Responsable': 'ğŸ‘¤',\n      'Categoria_Producto': 'ğŸ“',\n      'Ubicacion_Almacenamiento': 'ğŸ¢'\n    }[field] || 'ğŸ“';\n    response += `   ${emoji} ${field.replace(/_/g, ' ')}\\n`;\n  });\n  response += `\\n`;\n}\n\n// ğŸ’¡ SUGERENCIAS\nresponse += `ğŸ’¡ **PrÃ³ximos pasos:**\\n`;\nresponse += `â€¢ Para ver el inventario: \\\"Â¿QuÃ© hay en almacenamiento?\\\"\\n`;\nresponse += `â€¢ Para agregar mÃ¡s: \\\"Agregar variedad [nombre], [peso]g, responsable [persona]\\\"\\n`;\nresponse += `â€¢ Para buscar especÃ­fico: \\\"Mostrar registros de [variedad/responsable]\\\"\\n`;\n\nreturn {\n  json: {\n    response: response,\n    action: \"write\",\n    created_id: createdRecord.Id || createdRecord.id,\n    success: true,\n    extracted_fields: originalData.extracted_fields || []\n  }\n};"
      },
      "name": "âœ… Formatear Respuesta Escritura",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1200, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}"
      },
      "name": "ğŸš€ Responder a OpenWebUI",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1400, 300]
    },
    {
      "parameters": {
        "jsCode": "// ğŸš¨ MANEJADOR DE ERRORES\nconst error = $input.first().json.error || 'Error desconocido';\nconst originalMessage = $('Analizador de IntenciÃ³n').first()?.json?.user_message || 'Mensaje no disponible';\n\nlet errorResponse = `âš ï¸ **Oops! Hubo un problema**\\n\\n`;\n\nif (error.includes('401') || error.includes('unauthorized')) {\n  errorResponse += `ğŸ” **Error de autenticaciÃ³n con NocoDB**\\n`;\n  errorResponse += `â€¢ Verifica que el token de NocoDB estÃ© configurado correctamente\\n`;\n  errorResponse += `â€¢ Contacta al administrador del sistema\\n`;\n} else if (error.includes('404')) {\n  errorResponse += `ğŸ” **No se encontrÃ³ el recurso**\\n`;\n  errorResponse += `â€¢ La tabla de NocoDB podrÃ­a no existir\\n`;\n  errorResponse += `â€¢ Verifica la configuraciÃ³n del workflow\\n`;\n} else if (error.includes('network') || error.includes('ECONNREFUSED')) {\n  errorResponse += `ğŸŒ **Error de conexiÃ³n**\\n`;\n  errorResponse += `â€¢ NocoDB podrÃ­a no estar ejecutÃ¡ndose\\n`;\n  errorResponse += `â€¢ Verifica que el servicio estÃ© activo en puerto 3091\\n`;\n} else {\n  errorResponse += `ğŸ“‹ **Error general:**\\n\\`\\`\\`\\n${error}\\n\\`\\`\\`\\n`;\n}\n\nerrorResponse += `\\nğŸ“ **Tu mensaje:** \\\"${originalMessage}\\\"\\n`;\nerrorResponse += `\\nğŸ”„ **Intenta nuevamente en unos momentos**\\n`;\nerrorResponse += `ğŸ’¬ *O pregÃºntame sobre el estado del sistema*`;\n\nreturn {\n  json: {\n    response: errorResponse,\n    action: \"error\",\n    error_type: error,\n    success: false\n  }\n};"
      },
      "name": "ğŸš¨ Manejador de Errores",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1000, 600]
    }
  ],
  "connections": {
    "ğŸ“¡ Webhook OpenWebUI": {
      "main": [
        [
          {
            "node": "ğŸ§  Analizador de IntenciÃ³n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ§  Analizador de IntenciÃ³n": {
      "main": [
        [
          {
            "node": "ğŸ¤” Â¿Escribir o Leer?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¤” Â¿Escribir o Leer?": {
      "main": [
        [
          {
            "node": "ğŸ” Extractor de Datos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“– Leer de NocoDB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Extractor de Datos": {
      "main": [
        [
          {
            "node": "ğŸ’¾ Escribir en NocoDB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ Escribir en NocoDB": {
      "main": [
        [
          {
            "node": "âœ… Formatear Respuesta Escritura",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "ğŸš¨ Manejador de Errores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“– Leer de NocoDB": {
      "main": [
        [
          {
            "node": "ğŸ“Š Formatear Respuesta Lectura",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "ğŸš¨ Manejador de Errores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Formatear Respuesta Lectura": {
      "main": [
        [
          {
            "node": "ğŸš€ Responder a OpenWebUI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ… Formatear Respuesta Escritura": {
      "main": [
        [
          {
            "node": "ğŸš€ Responder a OpenWebUI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸš¨ Manejador de Errores": {
      "main": [
        [
          {
            "node": "ğŸš€ Responder a OpenWebUI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  }
}